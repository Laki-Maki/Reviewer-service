# PR Reviewer Assignment Service

Сервис автоматического назначения ревьюеров для Pull Request (PR) внутри команд.

## Основные возможности

- **Управление командами и участниками**
- **Создание PR** с автоматическим назначением до 2 ревьюверов из команды автора
- **Merge PR** (идемпотентно) и переназначение ревьюверов
- **Получение списка PR**, где пользователь назначен ревьювером
- **Отслеживание статуса PR** (OPEN / MERGED)
- **HTTP API**, полностью соответствующее OpenAPI-спецификации

## Технологический стек

- **Язык**: Go (Golang)
- **База данных**: PostgreSQL
- **HTTP роутер**: chi
- **Docker & Docker Compose** - контейнеризация сервиса и базы данных

## Архитектура

Проект разделён на слои:

- **Handlers**: обработка HTTP-запросов и валидация данных
- **Services**: бизнес-логика (назначение ревьюверов, merge PR, переназначение)
- **Repositories**: SQL-запросы к PostgreSQL
- **Models**: определение сущностей (User, Team, PullRequest)
- **Database**: подключение к базе и миграции

## Основные сущности

| Сущность | Описание |
|----------|----------|
| **User** | Участник команды с уникальным id, именем и флагом активности |
| **Team** | Группа пользователей с уникальным именем |
| **PullRequest** | PR с id, названием, автором, статусом (OPEN/MERGED) и до 2 назначенными ревьюверами |
| **Reviewer** | Пользователь, назначенный на PR |

## Бизнес-правила

- Автор PR не может быть ревьювером
- Назначаются только активные пользователи
- Merge PR идемпотентен
- Если доступных кандидатов меньше двух — назначается 0 или 1
- Выбор ревьюверов детерминированный по минимальной нагрузке (количество активных PR)

## Логирование и производительность

- **Структурированное логирование** через zap (DEBUG, INFO, WARN, ERROR)
- **Транзакционные операции** — при ошибках изменения откатываются
- **Индексы** для ускорения поиска пользователей, PR и ревьюверов
- **Равномерное распределение нагрузки** при выборе ревьюверов

Выбор кандидатов делается детерминированно по минимальной нагрузке: сначала считаются назначенные PR каждого кандидата, затем выбираются те с наименьшим количеством текущих назначений. Если несколько кандидатов имеют одинаковую минимальную нагрузку, выбирается тот, кто первым встречается в списке, то есть случайность больше не применяется — алгоритм стал предсказуемым. Таким образом нагрузка распределяется равномерно и стабильно, без рандома.


Все критичные операции сервиса выполняются транзакционно, что гарантирует целостность данных: если что-то идёт не так, изменения откатываются полностью. Для ускорения запросов по пользователям, PR и ревьюерам добавлены индексы, что позволяет мгновенно получать назначенные PR и проверять статусы. Это обеспечивает атомарность операций, защиту от гонок и стабильную производительность даже при росте объёма данных. В итоге сервис остаётся предсказуемым и надёжным при параллельной работе.

## Быстрый старт

Поднять сервис и базу данных:

```bash
docker-compose up --build
```
Сервис будет доступен по адресу: http://localhost:8080

## Что реализовано

- ✅ Подключение к PostgreSQL с миграциями и тестовыми данными
- ✅ Создание PR с автоматическим назначением ревьюверов
- ✅ Merge PR (идемпотентно)
- ✅ Переназначение ревьюверов
- ✅ Получение PR для ревьювера
- ✅ Управление активностью пользователей
- ✅ Полный HTTP API для интеграции
- ✅ Поддержка Docker Compose

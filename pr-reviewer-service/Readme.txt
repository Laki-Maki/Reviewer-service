PR Reviewer Assignment Service 
Описание проекта

Сервис автоматического назначения ревьюеров для Pull Request’ов (PR) внутри команды.
Он позволяет:

Управлять командами и участниками.

Создавать PR и автоматически назначать ревьюверов из команды автора.

Переназначать ревьюверов при необходимости.

Получать список PR’ов, где конкретный пользователь назначен ревьювером.

Отслеживать статус PR (OPEN / MERGED).

Сервис реализован как HTTP API и полностью соответствует OpenAPI-спецификации.

Стек технологий

Язык: Go (Golang)

База данных: PostgreSQL

HTTP роутер: chi

Docker: контейнеризация сервиса и базы данных

Docker Compose: поднимает сервис и базу командой docker-compose up

Архитектура

Проект разделён на несколько слоёв:

Handlers (internal/handlers)
Обрабатывают HTTP-запросы, валидируют входящие данные и вызывают сервисный слой.
Примеры маршрутов:

/users/setIsActive — установка активности пользователя

/users/getReview — получение PR, где пользователь назначен ревьювером

/pullRequest/create — создание PR и назначение ревьюверов

/pullRequest/merge — пометка PR как MERGED

/pullRequest/reassign — переназначение ревьювера

Services (internal/services)
Содержат бизнес-логику:

Назначение до 2 активных ревьюверов при создании PR

Исключение автора из списка ревьюверов

Идемпотентная операция merge

Переназначение ревьюверов внутри команды

Проверка доступности кандидатов для ревью

Repositories (internal/repositories)
Содержат все SQL-запросы к базе данных, изолируя логику работы с PostgreSQL от сервисного слоя.

Models (internal/models)
Определяют сущности проекта: User, Team, PullRequest.

Database (internal/db)

pq.go — подключение к PostgreSQL с повторными попытками ping.

migrations/001_init.sql — создание всех таблиц (users, teams, team_members, pull_requests, pr_reviewers).

migrations/002_seed.sql — начальные тестовые данные для команд и пользователей.

Основные сущности
Сущность	Описание
User	Участник команды с уникальным идентификатором, именем и флагом активности (isActive).
Team	Группа пользователей с уникальным именем.
PullRequest (PR)	PR имеет id, название, автора, статус (OPEN / MERGED) и список назначенных ревьюверов (до 2).
Reviewer	Пользователь, назначенный на PR.
Функционал

Управление пользователями и командами

Создание и обновление команд и участников (через API /team/add).

Установка активности пользователя (/users/setIsActive).

Работа с Pull Request

Создание PR с автоматическим назначением до 2 активных ревьюверов из команды автора (/pullRequest/create).

Merge PR (/pullRequest/merge) — идемпотентная операция.

Переназначение ревьювера на другого активного участника из команды (/pullRequest/reassign).

Получение всех PR, где пользователь назначен ревьювером (/users/getReview).

Бизнес-правила

Автор PR не может быть назначен ревьювером.

Неактивные пользователи не назначаются на ревью.

После MERGED изменение списка ревьюверов запрещено.

Если доступных кандидатов меньше двух — назначается доступное количество (0 или 1).

Структура проекта
pr-reviewer-service/
├── cmd/app/main.go            # Точка входа, запуск сервера
├── internal/config/config.go  # Конфигурация (пока пусто)
├── internal/db/pq.go          # Подключение к базе
├── internal/db/migrations/    # Миграции и тестовые данные
│   ├── 001_init.sql
│   └── 002_seed.sql
├── internal/handlers/          # HTTP-хэндлеры
├── internal/models/            # Модели: User, Team, PullRequest
├── internal/repositories/      # Работа с БД
├── internal/services/          # Бизнес-логика
├── Dockerfile
├── docker-compose.yml
├── Makefile
├── go.mod
└── go.sum

Запуск проекта

Поднять базу и сервис:

docker-compose up --build


Сервис будет доступен по адресу:

http://localhost:8080


Примеры API-запросов (через curl или Postman):

Создание PR:

POST /pullRequest/create
{
  "pull_request_name": "Add search",
  "author_id": 1,
  "team_id": 1
}


Merge PR:

POST /pullRequest/merge
{
  "pull_request_id": 1
}


Получение PR для ревьювера:

GET /users/getReview?user_id=2


Переназначение ревьювера:

POST /pullRequest/reassign
{
  "pull_request_id": 1,
  "old_user_id": 2,
  "new_user_id": 5
}

Что уже реализовано

✅ Подключение к PostgreSQL с миграциями и сидом данных
✅ Полная структура базы (users, teams, team_members, pull_requests, pr_reviewers)
✅ Создание PR с автоматическим назначением ревьюверов
✅ Merge PR (идемпотентно)
✅ Переназначение ревьюверов
✅ Получение списка PR для ревьювера
✅ Управление активностью пользователей
✅ Полностью готовый HTTP API для интеграции с фронтендом или тестами
✅ Поддержка Docker и Docker Compose для быстрого поднятия сервиса



Документация по логированию в проекте PR-Reviewer-Service
1️⃣ Общие принципы

Используем zap от Uber для структурированного логирования.

Все логи должны быть структурированными, с ключами (zap.Int, zap.String, zap.Error) для удобного поиска и фильтрации.

Уровни логов:

DEBUG — подробная информация для разработки и отладки (например, внутренние данные функций).

INFO — важные события, которые успешно произошли (создание PR, успешное слияние).

WARN — некритические ошибки или некорректные действия пользователя (например, ошибка декодирования запроса).

ERROR — критические ошибки, которые нарушают бизнес-логику или требуют вмешательства (например, ошибка БД, не удалось переназначить ревьювера).

Не логируем чувствительные данные, такие как пароли или токены.

2️⃣ Уровни логирования по компонентам
2.1 DB (db/db.go)

INFO: успешное подключение к базе (Connected to PostgreSQL!).

WARN: временные ошибки подключения (Waiting for database... attempt X).

ERROR: окончательная ошибка подключения после всех попыток.

2.2 Main (main.go)

INFO: запуск HTTP сервера (Server started on :8080).

2.3 Handlers
PR Handlers (pr_handler.go)
Событие	Уровень	Пример
Ошибка декодирования запроса	WARN	Failed to decode CreatePR request
Ошибка создания PR	ERROR	Failed to create PR с author_id
Успешное создание PR	INFO	Created new Pull Request с pr_id и author_id
Ошибка слияния PR	ERROR	Failed to merge PR с pr_id
Успешное слияние PR	INFO	Merged Pull Request с pr_id
Ошибка переназначения ревьювера	ERROR	Failed to reassign reviewer с pr_id и old_user_id
Успешное переназначение	INFO	Reassigned PR reviewer с pr_id, old_user_id, new_user_id
Team Handlers (team_handler.go)

WARN: ошибка декодирования запроса.

ERROR: ошибка добавления команды.

INFO: успешное создание команды.

ERROR: команда не найдена при запросе (GetTeam).

User Handlers (user_handler.go)

WARN: ошибка декодирования запроса.

ERROR: ошибка установки активности пользователя.

INFO: успешная смена активности.

ERROR: при запросе Assigned PR (GetReview), если ошибка.

2.4 Сервисы

PRService: внутренние операции (выбор кандидатов, генерация ревьюверов) можно логировать как DEBUG для отладки.

TeamService и UserService: логирование не требуется, так как ошибки поднимаются до хэндлеров.


Под «нагрузкой» я имею в виду количество активных PR, которые уже назначены на конкретного ревьювера.

Идея такая:

Если у кого-то из команды уже много ревью, то логично не назначать его снова, пока есть менее загруженные кандидаты.

То есть мы хотим равномерно распределять PR между участниками команды, чтобы один человек не получал все ревью, а другой не оставался без работы.

Сейчас выбор кандидатов делается детерминированно по минимальной нагрузке: сначала считаются назначенные PR каждого кандидата, затем выбираются те с наименьшим количеством текущих назначений. Если несколько кандидатов имеют одинаковую минимальную нагрузку, выбирается тот, кто первым встречается в списке, то есть случайность больше не применяется — алгоритм стал предсказуемым. Таким образом нагрузка распределяется равномерно и стабильно, без рандома.


Все критичные операции сервиса выполняются транзакционно, что гарантирует целостность данных: если что-то идёт не так, изменения откатываются полностью. Для ускорения запросов по пользователям, PR и ревьюерам добавлены индексы, что позволяет мгновенно получать назначенные PR и проверять статусы. Это обеспечивает атомарность операций, защиту от гонок и стабильную производительность даже при росте объёма данных. В итоге сервис остаётся предсказуемым и надёжным при параллельной работе.